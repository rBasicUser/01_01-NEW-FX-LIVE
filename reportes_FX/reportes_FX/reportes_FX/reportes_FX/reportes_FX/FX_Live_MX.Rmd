---
title: "FX Live - An√°lisis T√©cnico y de Riesgo - M√©xico"
author: "Central American Business Intelligence"
date: "`r format(Sys.Date(), '%d de %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: 
      collapsed: false
      smooth_scroll: true
    theme: flatly
    highlight: tango
    css: "styles.css"
    code_folding: hide
editor_options: 
  markdown: 
    wrap: 72
---

```{=html}

.alert {
  padding: 15px;
  margin-bottom: 20px;
  border: 1px solid transparent;
  border-radius: 4px;
}
.alert-warning {
  color: #8a6d3b;
  background-color: #fcf8e3;
  border-color: #faebcc;
}
.alert-success {
  color: #3c763d;
  background-color: #dff0d8;
  border-color: #d6e9c6;
}
.alert-danger {
  color: #a94442;
  background-color: #f2dede;
  border-color: #ebccd1;
}
.metric-card {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 15px;
  margin: 10px 0;
  border-left: 4px solid #007bff;
}
.trend-up { color: #28a745; font-weight: bold; }
.trend-down { color: #dc3545; font-weight: bold; }
.trend-neutral { color: #6c757d; font-weight: bold; }
.side-by-side {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  align-items: flex-start;
}
.side-by-side > div {
  flex: 1;
  min-width: 300px;
}

```
  
  
```{r setup, include=FALSE}
library(extrafont)
library(scales)
library(tidyverse)
library(lubridate)
library(kableExtra)
library(DT)
library(zoo)      # rollmean / rollapply
library(moments)  # skewness / kurtosis

knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE, 
  warning = FALSE,
  fig.width = 10,
  fig.height = 6,
  dpi = 300,
  comment = NA
)

# Par√°metros
lookback_months <- 12
confidence_level <- 0.95

# Tema visual
theme_fx <- function() {
  theme_minimal(base_family="Century Gothic") +
    theme(
      plot.title = element_text(size = 14, face = "bold", margin = margin(b = 20)),
      plot.subtitle = element_text(size = 11, color = "gray60"),
      axis.title = element_text(size = 11),
      axis.text = element_text(size = 10),
      legend.position = "bottom",
      panel.grid.minor = element_blank(),
      plot.caption = element_text(size = 9, color = "gray50", hjust = 0)
    )
}
```

```{r data-load, include=FALSE}

# Cargar datos y preparar M√©tricas
source("../scripts/pilot MX.R")

# Observaciones actuales
current_data <- df_data %>% dplyr::slice_tail(n = 1)
previous_data <- df_data %>% dplyr::slice_tail(n = 2) %>% dplyr::slice_head(n = 1)
```

# üìä Resumen Ejecutivo

::: metric-card
**Fecha del An√°lisis:** `r format(current_data$Fecha, '%d de %B, %Y')`

**Precio Actual:**
`r number(current_data$D_Close, accuracy = 0.01, big.mark = ",")`
(`r if_else(current_data$D_Close > previous_data$D_Close, "‚ÜóÔ∏è", "‚ÜòÔ∏è")`
`r percent((current_data$D_Close / previous_data$D_Close) - 1, accuracy = 0.01)`
vs d√≠a anterior)

**Tendencia General:** `r current_data$trend_long` (Largo Plazo)

**Posici√≥n en Bandas de Bollinger:** `r current_data$bb_signal`

**Percentil Historico:** `r round(current_data$Percentile, 1)`/100
:::

```{r alerts, results="asis"}
# Alertas
alerts <- list()

if (current_data$Outside20) {
  alert_type <- if_else(current_data$D_Close > current_data$Higher20, "warning", "danger")
  alert_msg <- if_else(
    current_data$D_Close > current_data$Higher20, 
    "‚ö†Ô∏è Precio fuera de banda superior (20 per√≠odos) - Posible sobredepreciaci√≥n",
    "üö® Precio fuera de banda inferior (20 per√≠odos) - Posible sobreapreciaci√≥n"
  )
  alerts <- append(alerts, list(list(type = alert_type, message = alert_msg)))
}

if (!is.na(current_data$rsi)) {
  if (current_data$rsi > 70) {
    alerts <- append(alerts, list(list(type = "warning", message = "‚ö†Ô∏è RSI indica condici√≥n de sobredepreciaci√≥n")))
  } else if (current_data$rsi < 30) {
    alerts <- append(alerts, list(list(type = "danger", message = "üö® RSI indica condici√≥n de sobreapreciaci√≥n")))
  }
}

if (abs(current_data$`%D`) > quantile(abs(df_data$`%D`), 0.95, na.rm = TRUE)) {
  alerts <- append(alerts, list(list(type = "warning", message = "‚ö†Ô∏è Movimiento diario inusual detectado")))
}

if (length(alerts) > 0) {
  for (alert in alerts) {
    cat(paste0('<div class="alert alert-', alert$type, '">', alert$message, '</div>'))
  }
} else {
  cat('<div class="alert alert-success">‚úÖ No se detectaron se√±ales de alerta inmediatas</div>')
}
```

# üìà Posici√≥n Actual

```{r current-position}
# Construcci√≥n expl√≠cita (evita rename/select/pivot_longer con tipos mixtos)
library(tibble)


current_formatted <- tibble(
  M√©trica = c(
    "Precio",
    "Cambio Respecto al d√≠a anterior (%)",
    "Cambio Semanal (%)",
    "Cambio Anual (%)",
    "Volatilidad (20d)",
    "Tendencia Corto",
    "Tendencia Medio",
    "Tendencia Largo"
  ),
  Valor = c(
    scales::number(current_data$D_Close, accuracy = 0.01, big.mark = ","),
    scales::percent(current_data$`%D`, accuracy = 0.01),
    scales::percent(current_data$`%W`, accuracy = 0.01),
    scales::percent(current_data$YoY, accuracy = 0.01),
    paste0("Q ", round((current_data$volatility_20 / 100 * current_data$D_Close), 3)),
    as.character(current_data$trend_short),
    as.character(current_data$trend_medium),
    as.character(current_data$trend_long)
  )
)

current_formatted %>%
  kable("html", align = c("l", "r")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed"), position = "center") %>%
  row_spec(0, bold = TRUE, background = "#f8f9fa") %>%
  column_spec(1, bold = TRUE, width = "200px") %>%
  column_spec(2, width = "150px")

```

# üìä An√°lisis T√©cnico

## Precio vs Medias M√≥viles y Bandas de Bollinger

```{r bollinger-enhanced, fig.height=8}
library(patchwork)
recent_data <- df_data %>% dplyr::filter(Fecha >= (Sys.Date() - months(18)))

# Ventanas de tiempo
end_date <- max(df_data$Fecha, na.rm = TRUE)
data_60m <- df_data %>% filter(Fecha >= (end_date %m-% months(60)))
data_24m <- df_data %>% filter(Fecha >= (end_date %m-% months(18)))

# --- Gr√°fico superior: Precio + SMA200 (60 meses) ---
p_top <- ggplot(data_60m, aes(x = Fecha)) +
  geom_line(aes(y = D_Close), color = "black", linewidth = 0.9) +
  geom_line(aes(y = SMA200), color = "#1e567c", linewidth = 0.9, alpha = 0.9) +
  labs(
    title = "Tendencia de Largo Plazo (5 a√±os)",
    x = NULL, y = "Nivel del Tipo de Cambio",
    caption = "SMA200: tendencia de largo plazo"
  ) +
  theme_fx()

print(p_top)

# --- Gr√°fico inferior: SMA50 y SMA20 (24 meses) ---
p_bottom <- ggplot(data_24m, aes(x = Fecha)) +
  # Si tienes bandas de Bollinger ya calculadas:
  geom_line(aes(y = D_Close), color = "black", linewidth = 0.9) +
  geom_point(data = current_data, aes(x= Fecha, y = D_Close), color = "red", size = 3, inherit.aes = FALSE) +
  geom_ribbon(aes(ymin = Lower20, ymax = Higher20), alpha = 0.15, fill = "#86bde2") +
  geom_ribbon(aes(ymin = Lower50, ymax = Higher50), alpha = 0.10, fill = "#338fce") +
  geom_line(aes(y = SMA50), color = "#338fce", linewidth = 0.9) +
  geom_line(aes(y = SMA20), color = "#86bde2", linewidth = 0.9) +
  labs(
    title = "Tendencia de Corto Plazo (a√±o y medio)",
    x = NULL, y = "Nivel del Tipo de Cambio",
    caption = "Bandas: SMA20¬±1SD (clara), SMA50¬±1SD (mediano plazo)"
  ) +
  theme_fx()

# --- Ensamble con patchwork: uno sobre otro ---
print(p_bottom)
```

## An√°lisis de Volatilidad

```{r volatility-analysis}
# Paso 1: transformar la serie en dinero (precio del d√≠a)
recent_data <- recent_data %>%
  mutate(vol20_money = volatility_20 * D_Close / 100)

# Paso 2: calcular la mediana de ese periodo en dinero
mediana_money <- median(recent_data$vol20_money, na.rm = TRUE)

# Paso 3: graficar
p3 <- ggplot(recent_data, aes(x = Fecha)) +
  geom_area(aes(y = vol20_money), alpha = 0.3) +
  geom_line(aes(y = vol20_money), linewidth = 0.8) +
  geom_hline(yintercept = mediana_money, linetype = "dashed", alpha = 0.7) +
  labs(
    title = "Volatilidad Hist√≥rica (20 d√≠as)",
    subtitle = "Anualizada, expresada en dinero",
    y = "Volatilidad (dinero por unidad)",
    x = "Fecha",
    caption = "L√≠nea discontinua: mediana del periodo"
  ) +
  theme_fx()

print(p3)

```

## Retorno y Riesgo  

::: {.side-by-side}
::: {}
```{r risk-metrics}
calculate_var <- function(returns, confidence = 0.95) {
  as.numeric(quantile(returns, confidence, na.rm = TRUE))
}

calculate_max_drawdown <- function(prices) {
  log_p <- log(prices)
  cummax_log <- cummax(log_p)
  drawdown <- exp(log_p - cummax_log) - 1
  max(drawdown, na.rm = TRUE)
}

daily_returns <- df_data$`%D`
weekly_return <- df_data$`%W`
annual_returns <- df_data$YoY

# Calcular VaR en dinero
var_daily_pct <- calculate_var(daily_returns, 0.95)
var_weekly_pct <- calculate_var(weekly_returns, 0.95)
var_annual_pct <- calculate_var(annual_returns, 0.95)
var_daily_money <- var_daily_pct * current_data$D_Close
var_weekly_money <- var_weekly_pct * current_data$D_Close
var_annual_money <- var_annual_pct * current_data$D_Close

risk_metrics <- tibble(
  M√©trica = c(
    "VaR Diario (95%) - En dinero",
    "VaR Diario (95%) - En %",
    "VaR Semanal (95%) - En dinero",
    "VaR Semanal (95%) - En %",
    "VaR Anual (95%) - En dinero",
    "VaR Anual (95%) - En %",
    "M√°xima P√©rdida Hist√≥rica (Max Drawdown)",
    "Volatilidad Actual (20d)",
    "Volatilidad Hist√≥rica (Anual)",
    "Sharpe Ratio (aprox.)"
  ),
  Valor = c(
    abs(var_daily_money),
    abs(var_daily_pct) * 100,
    abs(var_weekly_money),
    abs(var_weekly_pct) * 100,
    abs(var_annual_money),
    abs(var_annual_pct) * 100,
    calculate_max_drawdown(df_data$D_Close) * 100,
    current_data$volatility_20,
    sd(daily_returns, na.rm = TRUE) * sqrt(252) * 100,
    (mean(daily_returns, na.rm = TRUE) / sd(daily_returns, na.rm = TRUE)) * sqrt(252)
  ),
  Unidad = c("Q", "%", "Q", "%", "Q", "%", "%", "%", "%", "ratio")
) %>%
  mutate(
    Valor_fmt = dplyr::case_when(
      Unidad == "%" ~ paste0(scales::number(Valor, accuracy = 0.01), " %"),
      Unidad == "Q" ~ paste0("Q ", scales::number(Valor, accuracy = 0.01)),
      TRUE ~ scales::number(Valor, accuracy = 0.01)
    )
  )

risk_metrics %>%
  dplyr::select(M√©trica, Valor_fmt) %>%
  kable("html", caption = "M√©tricas de Riesgo y Performance", col.names = c("M√©trica", "Valor")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed")) %>%
  row_spec(0, bold = TRUE) %>%
  pack_rows("Value at Risk", 1, 6) %>%
  pack_rows("M√©tricas de Volatilidad", 7, 9) %>%
  pack_rows("Ratio de Performance", 10, 10)
```
:::

::: {}
```{r trend-analysis}
trend_summary <- df_data %>%
  dplyr::filter(Fecha >= (Sys.Date() - months(6))) %>%
  dplyr::mutate(Mes = lubridate::floor_date(Fecha, "month")) %>%
  dplyr::group_by(Mes) %>%
  dplyr::summarise(
    Retorno_Mensual = (dplyr::last(D_Close) / dplyr::first(D_Close) - 1) * 100,
    .groups = "drop_last"
  ) %>%
  dplyr::ungroup()

trend_summary %>%
  dplyr::select(Mes, Retorno_Mensual) %>%
  dplyr::mutate(
    Mes = format(Mes, "%B %Y"),
    Retorno_Mensual = paste0(round(Retorno_Mensual, 2), "%")
  ) %>%
  kable("html", caption = "Rendimientos Mensuales (√öltimos 6 meses)",
        col.names = c("Mes", "Retorno Mensual")) %>%
  kable_styling(full_width = TRUE, bootstrap_options = c("striped", "hover", "condensed")) %>%
  row_spec(0, bold = TRUE)
```
:::
:::

# üìà An√°lisis de Distribuciones

```{r distributions, fig.height=10}
p4 <- df_data %>%
  dplyr::select(Fecha, `%D`, `%W`, YoY) %>%
  tidyr::pivot_longer(cols = c(`%D`, `%W`, YoY), names_to = "Periodo", values_to = "Retorno") %>%
  dplyr::mutate(
    Retorno_pct = Retorno * 100,
    Periodo = dplyr::case_when(
      Periodo == "%D" ~ "Diario",
      Periodo == "%W" ~ "Semanal", 
      TRUE ~ "Anual"
    )
  ) %>%
  ggplot(aes(x = Retorno_pct)) +
  geom_histogram(aes(y = after_stat(density)), bins = 50, alpha = 0.7) +
  geom_density(linewidth = 1) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  facet_wrap(~Periodo, scales = "free", ncol = 1) +
  labs(
    title = "Distribuci√≥n de Retornos por Per√≠odo",
    subtitle = "Histograma con curva de densidad estimada",
    x = "Retorno (%)",
    y = "Densidad"
  ) +
  theme_fx()

print(p4)
```

# üìä Dashboard de Se√±ales

```{r signals-dashboard}
signals_data <- tibble(
  Indicador = c(
    "Precio vs SMA20",
    "Precio vs SMA50", 
    "Precio vs SMA200",
    "SMA20 vs SMA50",
    "SMA50 vs SMA200",
    "Bandas Bollinger (20)",
    "RSI (14)",
    "Volatilidad vs Mediana"
  ),
  Se√±al = c(
    if_else(current_data$D_Close > current_data$SMA20, "Depreciaci√≥n", "Apreciaci√≥n"),
    if_else(current_data$D_Close > current_data$SMA50, "Depreciaci√≥n", "Apreciaci√≥n"),
    if_else(current_data$D_Close > current_data$SMA200, "Depreciaci√≥n", "Apreciaci√≥n"),
    if_else(current_data$SMA20 > current_data$SMA50, "Depreciaci√≥n", "Apreciaci√≥n"),
    if_else(current_data$SMA50 > current_data$SMA200, "Depreciaci√≥n", "Apreciaci√≥n"),
    current_data$bb_signal,
    case_when(
      is.na(current_data$rsi) ~ "N/A",
      current_data$rsi > 70 ~ "Sobrecompra",
      current_data$rsi < 30 ~ "Sobreventa",
      TRUE ~ "Neutral"
    ),
    if_else(current_data$volatility_20 > median(df_data$volatility_20, na.rm = TRUE), "Alta", "Normal")
  ),
) %>%
  mutate(
    Color = case_when(
      Se√±al %in% c("Depreciaci√≥n", "Alta") ~ "success",
      Se√±al %in% c("Apreciaci√≥n", "Sobreventa") ~ "danger", 
      Se√±al %in% c("Sobrecompra") ~ "warning",
      TRUE ~ "secondary"
    )
  )

signals_data %>%
  dplyr::select(Indicador, Se√±al) %>%
  kable("html", caption = "Dashboard de Se√±ales T√©cnicas", col.names = c("Indicador", "Se√±al")) %>%
  kable_styling(full_width = TRUE, bootstrap_options = c("striped", "hover", "condensed")) %>%
  row_spec(0, bold = TRUE) %>%
  pack_rows("Se√±ales de Precio", 1, 3) %>%
  pack_rows("Se√±ales de Tendencia", 4, 5) %>%
  pack_rows("Se√±ales de Momentum", 6, 7) %>%
  pack_rows("Se√±ales de Volatilidad", 8, 8)
```

------------------------------------------------------------------------

::: {style="margin-top: 30px; padding: 20px; background-color: #f8f9fa; border-radius: 5px;"}
<h4>üìù Notas Metodol√≥gicas</h4>

<ul>

<li><strong>Bandas de Bollinger:</strong> Calculadas usando SMA ¬± 1
desviaci√≥n est√°ndar</li>

<li><strong>RSI:</strong> √çndice de Fuerza Relativa de 14 per√≠odos</li>

<li><strong>VaR/CVaR:</strong> Value at Risk y Conditional VaR al 95% de
confianza</li>

<li><strong>Volatilidad:</strong> Anualizada usando factor ‚àö252</li>

<li><strong>Tendencias:</strong> Clasificadas seg√∫n posici√≥n relativa de
precios y medias m√≥viles</li>

</ul>
:::

::: {style="text-align: center; margin-top: 20px; color: #6c757d; font-size: 0.9em;"}
Reporte generado autom√°ticamente el
`r format(Sys.time(), '%d de %B, %Y a las %H:%M')` | ¬© Equipo de
Inteligencia de Negocios
:::
