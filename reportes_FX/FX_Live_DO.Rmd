---
title: "FX Live - An√°lisis T√©cnico y de Riesgo - Rep√∫blica Dominicana"
author: "Central American Business Intelligence"
date: "`r format(Sys.Date(), '%d de %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: 
      collapsed: false
      smooth_scroll: true
    theme: flatly
    highlight: tango
    css: "styles.css"
    code_folding: hide
editor_options: 
  markdown: 
    wrap: 72
---

```{=html}
<style>
.alert {
  padding: 15px;
  margin-bottom: 20px;
  border: 1px solid transparent;
  border-radius: 4px;
}
.alert-warning {
  color: #8a6d3b;
  background-color: #fcf8e3;
  border-color: #faebcc;
}
.alert-success {
  color: #3c763d;
  background-color: #dff0d8;
  border-color: #d6e9c6;
}
.alert-danger {
  color: #a94442;
  background-color: #f2dede;
  border-color: #ebccd1;
}
.metric-card {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 15px;
  margin: 10px 0;
  border-left: 4px solid #007bff;
}
.trend-up { color: #28a745; font-weight: bold; }
.trend-down { color: #dc3545; font-weight: bold; }
.trend-neutral { color: #6c757d; font-weight: bold; }
</style>
```

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(kableExtra)
library(scales)
library(ggplot2)
library(DT)
library(zoo)      # rollmean / rollapply
library(moments)  # skewness / kurtosis

knitr::opts_chunk$set(
  echo = FALSE, 
  message = FALSE, 
  warning = FALSE,
  fig.width = 10,
  fig.height = 6,
  dpi = 300,
  comment = NA
)

# Par√°metros
lookback_months <- 12
confidence_level <- 0.95

# Tema visual
theme_fx <- function() {
  theme_minimal() +
    theme(
      plot.title = element_text(size = 14, face = "bold", margin = margin(b = 20)),
      plot.subtitle = element_text(size = 11, color = "gray60"),
      axis.title = element_text(size = 11),
      axis.text = element_text(size = 10),
      legend.position = "bottom",
      panel.grid.minor = element_blank(),
      plot.caption = element_text(size = 9, color = "gray50", hjust = 0)
    )
}
```

```{r data-load, include=FALSE}

# Cargar datos y preparar M√©tricas
source("../scripts/pilot DO.R")

# Observaciones actuales
current_data <- df_data %>% dplyr::slice_tail(n = 1)
previous_data <- df_data %>% dplyr::slice_tail(n = 2) %>% dplyr::slice_head(n = 1)
```

# üìä Resumen Ejecutivo

::: metric-card
**Fecha del An√°lisis:** `r format(current_data$Fecha, '%d de %B, %Y')`

**Precio Actual:**
`r number(current_data$D_Close, accuracy = 0.01, big.mark = ",")`
(`r if_else(current_data$D_Close > previous_data$D_Close, "‚ÜóÔ∏è", "‚ÜòÔ∏è")`
`r percent((current_data$D_Close / previous_data$D_Close) - 1, accuracy = 0.01)`
vs d√≠a anterior)

**Tendencia General:** `r current_data$trend_long` (Largo Plazo)

**Posici√≥n en Bandas de Bollinger:** `r current_data$bb_signal`

**Percentil Historico:** `r round(current_data$Percentile, 1)`/100
:::

```{r alerts, results="asis"}
# Alertas
alerts <- list()

if (current_data$Outside20) {
  alert_type <- if_else(current_data$D_Close > current_data$Higher20, "warning", "danger")
  alert_msg <- if_else(
    current_data$D_Close > current_data$Higher20, 
    "‚ö†Ô∏è Precio fuera de banda superior (20 per√≠odos) - Posible sobredepreciaci√≥n",
    "üö® Precio fuera de banda inferior (20 per√≠odos) - Posible sobreapreciaci√≥n"
  )
  alerts <- append(alerts, list(list(type = alert_type, message = alert_msg)))
}

if (!is.na(current_data$rsi)) {
  if (current_data$rsi > 70) {
    alerts <- append(alerts, list(list(type = "warning", message = "‚ö†Ô∏è RSI indica condici√≥n de sobredepreciaci√≥n")))
  } else if (current_data$rsi < 30) {
    alerts <- append(alerts, list(list(type = "danger", message = "üö® RSI indica condici√≥n de sobreapreciaci√≥n")))
  }
}

if (abs(current_data$`%D`) > quantile(abs(df_data$`%D`), 0.95, na.rm = TRUE)) {
  alerts <- append(alerts, list(list(type = "warning", message = "‚ö†Ô∏è Movimiento diario inusual detectado")))
}

if (length(alerts) > 0) {
  for (alert in alerts) {
    cat(paste0('<div class="alert alert-', alert$type, '">', alert$message, '</div>'))
  }
} else {
  cat('<div class="alert alert-success">‚úÖ No se detectaron se√±ales de alerta inmediatas</div>')
}
```

# üìà Posici√≥n Actual

```{r current-position}
# Construcci√≥n expl√≠cita (evita rename/select/pivot_longer con tipos mixtos)
library(tibble)

current_formatted <- tibble(
  M√©trica = c(
    "Precio",
    "Cambio Diario (%)",
    "Cambio Semanal (%)",
    "Cambio Anual (%)",
    "RSI (14)",
    "Volatilidad (20d)",
    "Tendencia Corto",
    "Tendencia Medio",
    "Tendencia Largo"
  ),
  Valor = c(
    scales::number(current_data$D_Close, accuracy = 0.01, big.mark = ","),
    scales::percent(current_data$`%D`, accuracy = 0.01),
    scales::percent(current_data$`%W`, accuracy = 0.01),
    scales::percent(current_data$YoY, accuracy = 0.01),
    as.character(round(current_data$rsi, 1)),
    paste0(round(current_data$volatility_20, 1), "%"),
    as.character(current_data$trend_short),
    as.character(current_data$trend_medium),
    as.character(current_data$trend_long)
  )
)

current_formatted %>%
  kable("html", align = c("l", "r")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed"), position = "center") %>%
  row_spec(0, bold = TRUE, background = "#f8f9fa") %>%
  column_spec(1, bold = TRUE, width = "200px") %>%
  column_spec(2, width = "150px")

```

# üìä An√°lisis T√©cnico

## Precio vs Medias M√≥viles y Bandas de Bollinger

```{r bollinger-enhanced, fig.height=8}
recent_data <- df_data %>% dplyr::filter(Fecha >= (Sys.Date() - months(lookback_months)))

p1 <- ggplot(recent_data, aes(x = Fecha)) +
  geom_ribbon(aes(ymin = Lower20, ymax = Higher20), alpha = 0.15, fill = "blue") +
  geom_ribbon(aes(ymin = Lower50, ymax = Higher50), alpha = 0.10, fill = "orange") +
  geom_line(aes(y = SMA200), color = "red", linewidth = 0.8, alpha = 0.7) +
  geom_line(aes(y = SMA50), color = "orange", linewidth = 0.7) +
  geom_line(aes(y = SMA20), color = "blue", linewidth = 0.6) +
  geom_line(aes(y = D_Close), color = "black", linewidth = 1) +
  geom_point(data = current_data, aes(y = D_Close), color = "red", size = 3) +
  labs(title = "An√°lisis T√©cnico Integral", subtitle = "Precio, Medias M√≥viles y Bandas de Bollinger",
       y = "Nivel del Tipo de Cambio", x = NULL,
       caption = "Bandas: SMA20¬±1SD (azul), SMA50¬±1SD (naranja) | L√≠neas: SMA20 (azul), SMA50 (naranja), SMA200 (rojo)") +
  theme_fx()

print(p1)

p2 <- ggplot(recent_data, aes(x = Fecha, y = rsi)) +
  geom_hline(yintercept = c(30, 70), linetype = "dashed", color = "red", alpha = 0.7) +
  geom_hline(yintercept = 50, linetype = "solid", color = "gray", alpha = 0.5) +
  geom_line(linewidth = 0.8) +
  geom_point(data = current_data, aes(y = rsi), size = 3) +
  ylim(0, 100) +
  labs(title = "√çndice de Fuerza Relativa (RSI)", subtitle = "Se√±ales de sobrecompra (>70) y sobreventa (<30)", y = "RSI", x = "Fecha") +
  theme_fx()

print(p2)
```

## An√°lisis de Volatilidad

```{r volatility-analysis}
p3 <- ggplot(recent_data, aes(x = Fecha)) +
  geom_area(aes(y = volatility_20), alpha = 0.3) +
  geom_line(aes(y = volatility_20), linewidth = 0.8) +
  geom_hline(yintercept = median(df_data$volatility_20, na.rm = TRUE), linetype = "dashed", alpha = 0.7) +
  labs(title = "Volatilidad Hist√≥rica (20 d√≠as)", subtitle = "Anualizada en porcentaje", y = "Volatilidad (%)", x = "Fecha", caption = "L√≠nea discontinua: mediana hist√≥rica") +
  theme_fx()

print(p3)
```

# üìã Estad√≠sticas y M√©tricas de Riesgo

## Estad√≠sticos Descriptivos

```{r statistics-enhanced, results="asis"}
create_stats_table <- function(data_col, title) {
  data_bps <- data_col * 10000
  tbl <- tibble(
    M√©trica = c("Media", "Mediana", "Desv. Est√°ndar", "Varianza", 
                "Percentil 5%", "Percentil 95%", "M√°ximo", "M√≠nimo",
                "Sesgo", "Curtosis"),
    Valor_bps = c(
      mean(data_bps, na.rm = TRUE),
      median(data_bps, na.rm = TRUE),
      sd(data_bps, na.rm = TRUE),
      var(data_bps, na.rm = TRUE),
      quantile(data_bps, 0.05, na.rm = TRUE),
      quantile(data_bps, 0.95, na.rm = TRUE),
      max(data_bps, na.rm = TRUE),
      min(data_bps, na.rm = TRUE),
      moments::skewness(data_bps, na.rm = TRUE),
      moments::kurtosis(data_bps, na.rm = TRUE) - 3
    )
  ) %>%
    mutate(
      Valor_bps = dplyr::case_when(
        M√©trica %in% c("Sesgo", "Curtosis") ~ round(Valor_bps, 3),
        TRUE ~ round(Valor_bps, 2)
      ),
      Valor_bps = scales::number(Valor_bps, accuracy = 0.01)
    ) %>%
    kable("html", caption = title, col.names = c("M√©trica", "Valor (bps)")) %>%
    kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed")) %>%
    row_spec(0, bold = TRUE)
  
  return(tbl)
}

# Renderizar 3 tablas en columnas
cat('<div style="display: flex; justify-content: space-around;">')

cat('<div style="flex: 1; padding: 5px;">')
create_stats_table(df_data$`%D`, "Cambios Diarios (%D)")
cat('</div>')

cat('<div style="flex: 1; padding: 5px;">')
create_stats_table(df_data$`%W`, "Cambios Semanales (%W)")
cat('</div>')

cat('<div style="flex: 1; padding: 5px;">')
create_stats_table(df_data$YoY, "Cambios Anuales (YoY)")
cat('</div>')

cat('</div>')
```

## M√©tricas de Riesgo

```{r risk-metrics}
calculate_var <- function(returns, confidence = 0.95) {
  as.numeric(quantile(returns, 1 - confidence, na.rm = TRUE))
}

calculate_cvar <- function(returns, confidence = 0.95) {
  var_threshold <- calculate_var(returns, confidence)
  mean(returns[returns <= var_threshold], na.rm = TRUE)
}

calculate_max_drawdown <- function(prices) {
  log_p <- log(prices)
  cummax_log <- cummax(log_p)
  drawdown <- exp(log_p - cummax_log) - 1
  min(drawdown, na.rm = TRUE)
}

daily_returns <- df_data$`%D`
weekly_returns <- df_data$`%W`

risk_metrics <- tibble(
  M√©trica = c(
    "VaR Diario (95%)",
    "VaR Semanal (95%)",
    "M√°xima P√©rdida Hist√≥rica (Max Drawdown)",
    "Volatilidad Actual (20d)",
    "Volatilidad Hist√≥rica (Anual)",
    "Sharpe Ratio (aprox.)"
  ),
  Valor = c(
    calculate_var(daily_returns, confidence_level) * 10000,
    calculate_var(weekly_returns, confidence_level) * 10000,
    calculate_max_drawdown(df_data$D_Close) * 100,
    current_data$volatility_20,
    sd(daily_returns, na.rm = TRUE) * sqrt(252) * 100,
    (mean(daily_returns, na.rm = TRUE) / sd(daily_returns, na.rm = TRUE)) * sqrt(252)
  ),
  Unidad = c("bps", "bps", "%", "%", "%", "ratio")
) %>%
  mutate(
    Valor_fmt = dplyr::case_when(
      Unidad == "bps" ~ paste0(scales::number(Valor, accuracy = 0.1), " bps"),
      Unidad == "%" ~ paste0(scales::number(Valor, accuracy = 0.1), " %"),
      TRUE ~ scales::number(Valor, accuracy = 0.01)
    )
  )

risk_metrics %>%
  dplyr::select(M√©trica, Valor_fmt) %>%
  kable("html", caption = "M√©tricas de Riesgo y Performance", col.names = c("M√©trica", "Valor")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed")) %>%
  row_spec(0, bold = TRUE) %>%
  pack_rows("Value at Risk", 1, 3) %>%
  pack_rows("M√©tricas de Volatilidad", 3, 5) %>%
  pack_rows("Ratio de Performance", 6, 5)
```

# üìà An√°lisis de Distribuciones

```{r distributions, fig.height=10}
p4 <- df_data %>%
  dplyr::select(Fecha, `%D`, `%W`, YoY) %>%
  tidyr::pivot_longer(cols = c(`%D`, `%W`, YoY), names_to = "Periodo", values_to = "Retorno") %>%
  dplyr::mutate(
    Retorno_bps = Retorno * 10000,
    Periodo = dplyr::case_when(
      Periodo == "%D" ~ "Diario",
      Periodo == "%W" ~ "Semanal", 
      TRUE ~ "Anual"
    )
  ) %>%
  ggplot(aes(x = Retorno_bps)) +
  geom_histogram(aes(y = after_stat(density)), bins = 50, alpha = 0.7) +
  geom_density(linewidth = 1) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  facet_wrap(~Periodo, scales = "free", ncol = 1) +
  labs(
    title = "Distribuci√≥n de Retornos por Per√≠odo",
    subtitle = "Histograma con curva de densidad estimada",
    x = "Retorno (bps)",
    y = "Densidad"
  ) +
  theme_fx()

print(p4)
```

# üîç An√°lisis de Tendencias y Patrones

```{r trend-analysis}
trend_summary <- df_data %>%
  dplyr::filter(Fecha >= (Sys.Date() - months(6))) %>%
  dplyr::mutate(Mes = lubridate::floor_date(Fecha, "month")) %>%
  dplyr::group_by(Mes) %>%
  dplyr::summarise(
    D√≠as_Depreciaci√≥n_Corto = sum(trend_short == "Depreciaci√≥n", na.rm = TRUE),
    D√≠as_Apreciaci√≥n_Corto = sum(trend_short == "Apreciaci√≥n", na.rm = TRUE),
    D√≠as_Lateral_Corto = sum(trend_short == "Lateral", na.rm = TRUE),
    Total_D√≠as = dplyr::n(),
    Volatilidad_Promedio = mean(volatility_20, na.rm = TRUE),
    Retorno_Mensual = (dplyr::last(D_Close) / dplyr::first(D_Close) - 1) * 100,
    .groups = "drop_last"
  ) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(
    Porcentaje_Depreciaci√≥n = round(D√≠as_Depreciaci√≥n_Corto / Total_D√≠as * 100, 1),
    Porcentaje_Apreciaci√≥n = round(D√≠as_Apreciaci√≥n_Corto / Total_D√≠as * 100, 1),
    Porcentaje_Lateral = round(D√≠as_Lateral_Corto / Total_D√≠as * 100, 1)
  )

trend_summary %>%
  dplyr::select(Mes, Porcentaje_Depreciaci√≥n, Porcentaje_Apreciaci√≥n, Porcentaje_Lateral, Volatilidad_Promedio, Retorno_Mensual) %>%
  dplyr::mutate(
    Mes = format(Mes, "%B %Y"),
    Volatilidad_Promedio = paste0(round(Volatilidad_Promedio, 1), "%"),
    Retorno_Mensual = paste0(round(Retorno_Mensual, 2), "%")
  ) %>%
  kable("html", caption = "An√°lisis de Tendencias por Mes (√öltimos 6 meses)",
        col.names = c("Mes", "% Depreciaci√≥n", "% Apreciaci√≥n", "% Lateral", "Vol. Promedio", "Retorno Mensual")) %>%
  kable_styling(full_width = TRUE, bootstrap_options = c("striped", "hover", "condensed")) %>%
  row_spec(0, bold = TRUE)
```

# üìä Dashboard de Se√±ales

```{r signals-dashboard}
signals_data <- tibble(
  Indicador = c(
    "Precio vs SMA20",
    "Precio vs SMA50", 
    "Precio vs SMA200",
    "SMA20 vs SMA50",
    "SMA50 vs SMA200",
    "Bandas Bollinger (20)",
    "RSI (14)",
    "Volatilidad vs Mediana"
  ),
  Se√±al = c(
    if_else(current_data$D_Close > current_data$SMA20, "Depreciaci√≥n", "Apreciaci√≥n"),
    if_else(current_data$D_Close > current_data$SMA50, "Depreciaci√≥n", "Apreciaci√≥n"),
    if_else(current_data$D_Close > current_data$SMA200, "Depreciaci√≥n", "Apreciaci√≥n"),
    if_else(current_data$SMA20 > current_data$SMA50, "Depreciaci√≥n", "Apreciaci√≥n"),
    if_else(current_data$SMA50 > current_data$SMA200, "Depreciaci√≥n", "Apreciaci√≥n"),
    current_data$bb_signal,
    case_when(
      is.na(current_data$rsi) ~ "N/A",
      current_data$rsi > 70 ~ "Sobrecompra",
      current_data$rsi < 30 ~ "Sobreventa",
      TRUE ~ "Neutral"
    ),
    if_else(current_data$volatility_20 > median(df_data$volatility_20, na.rm = TRUE), "Alta", "Normal")
  ),
  Fuerza = c(
    abs(current_data$D_Close - current_data$SMA20) / current_data$SMA20 * 100,
    abs(current_data$D_Close - current_data$SMA50) / current_data$SMA50 * 100,
    abs(current_data$D_Close - current_data$SMA200) / current_data$SMA200 * 100,
    abs(current_data$SMA20 - current_data$SMA50) / current_data$SMA50 * 100,
    abs(current_data$SMA50 - current_data$SMA200) / current_data$SMA200 * 100,
    if_else(current_data$bb_signal == "Neutral", 0, abs(current_data$D_Close - current_data$SMA20) / (current_data$Higher20 - current_data$Lower20) * 100),
    if_else(is.na(current_data$rsi), 0, case_when(
      current_data$rsi > 70 ~ current_data$rsi - 70,
      current_data$rsi < 30 ~ 30 - current_data$rsi,
      TRUE ~ 0
    )),
    abs(current_data$volatility_20 - median(df_data$volatility_20, na.rm = TRUE))
  )
) %>%
  mutate(
    Fuerza_pct = paste0(round(Fuerza, 2), "%"),
    Color = case_when(
      Se√±al %in% c("Depreciaci√≥n", "Alta") ~ "success",
      Se√±al %in% c("Apreciaci√≥n", "Sobreventa") ~ "danger", 
      Se√±al %in% c("Sobrecompra") ~ "warning",
      TRUE ~ "secondary"
    )
  )

signals_data %>%
  dplyr::select(Indicador, Se√±al, Fuerza_pct) %>%
  kable("html", caption = "Dashboard de Se√±ales T√©cnicas", col.names = c("Indicador", "Se√±al", "Fuerza")) %>%
  kable_styling(full_width = TRUE, bootstrap_options = c("striped", "hover", "condensed")) %>%
  row_spec(0, bold = TRUE) %>%
  pack_rows("Se√±ales de Precio", 1, 3) %>%
  pack_rows("Se√±ales de Tendencia", 4, 5) %>%
  pack_rows("Se√±ales de Momentum", 6, 7) %>%
  pack_rows("Se√±ales de Volatilidad", 8, 8)
```

------------------------------------------------------------------------

::: {style="margin-top: 30px; padding: 20px; background-color: #f8f9fa; border-radius: 5px;"}
<h4>üìù Notas Metodol√≥gicas</h4>

<ul>

<li><strong>Bandas de Bollinger:</strong> Calculadas usando SMA ¬± 1
desviaci√≥n est√°ndar</li>

<li><strong>RSI:</strong> √çndice de Fuerza Relativa de 14 per√≠odos</li>

<li><strong>VaR/CVaR:</strong> Value at Risk y Conditional VaR al 95% de
confianza</li>

<li><strong>Volatilidad:</strong> Anualizada usando factor ‚àö252</li>

<li><strong>Tendencias:</strong> Clasificadas seg√∫n posici√≥n relativa de
precios y medias m√≥viles</li>

</ul>
:::

::: {style="text-align: center; margin-top: 20px; color: #6c757d; font-size: 0.9em;"}
Reporte generado autom√°ticamente el
`r format(Sys.time(), '%d de %B, %Y a las %H:%M')` | ¬© Equipo de
Inteligencia de Negocios
:::
