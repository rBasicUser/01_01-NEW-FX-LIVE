<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reportes Consolidados</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 16px; }
    .country-selector {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px; border-radius: 10px; margin-bottom: 30px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .selector-title { color: #fff; font-size: 24px; font-weight: bold; margin-bottom: 15px; text-align: center; }
    .country-buttons { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    .country-btn {
      background: rgba(255,255,255,0.2); color: #fff; border: 2px solid rgba(255,255,255,0.3);
      padding: 12px 20px; border-radius: 25px; cursor: pointer; transition: all .3s ease;
      font-weight: bold; backdrop-filter: blur(10px);
    }
    .country-btn.active { background: rgba(255,255,255,.35); border-color: rgba(255,255,255,.9); color:#1f2937; }
    .country-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .viewer-wrap { position: relative; height: 85vh; border:1px solid #e5e7eb; border-radius: 12px; overflow:hidden; }
    .viewer-wrap iframe {
      position: absolute; inset: 0; width: 100%; height: 100%; border: 0;
      opacity: 0; transition: opacity .35s ease; background: #fff;
    }
    .viewer-wrap iframe.show { opacity: 1; }
    .loader {
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      pointer-events:none; font-size:.95rem; color:#555; background: rgba(255,255,255,0.8);
      opacity:0; transition: opacity .2s ease; flex-direction: column; gap: 10px;
    }
    .loader.show { opacity:1; }
    .spinner {
      width: 40px; height: 40px; border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea; border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .error-message {
      position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
      background: #fee2e2; color: #dc2626; font-size: 16px; text-align: center;
      opacity: 0; transition: opacity .3s ease; flex-direction: column; gap: 15px;
    }
    .error-message.show { opacity: 1; }
    .retry-btn {
      background: #dc2626; color: white; border: none; padding: 10px 20px;
      border-radius: 6px; cursor: pointer; font-size: 14px;
    }
    .retry-btn:hover { background: #b91c1c; }
  </style>
</head>
<body>
  <section class="country-selector">
    <div class="selector-title">üåé Seleccione un Pa√≠s</div>
    <div class="country-buttons" id="picker"></div>
  </section>

  <div class="viewer-wrap" id="viewerWrap">
    <div class="loader" id="loader">
      <div class="spinner"></div>
      <div>Cargando reporte‚Ä¶</div>
    </div>
    <div class="error-message" id="errorMessage">
      <div>‚ö†Ô∏è Error al cargar el reporte</div>
      <button class="retry-btn" id="retryBtn">Reintentar</button>
    </div>
    <iframe id="frameA" title="Reporte A"></iframe>
    <iframe id="frameB" title="Reporte B"></iframe>
  </div>

  <script>
    const reportes = {
      "GT": { nombre: "Guatemala", archivo: "FX_Live_GT.html" },
      "HN": { nombre: "Honduras", archivo: "FX_Live_HN.html" },
      "CR": { nombre: "Costa Rica", archivo: "FX_Live_CR.html" },
      "DO": { nombre: "Rep√∫blica Dominicana", archivo: "FX_Live_DO.html" },
      "MX": { nombre: "M√©xico", archivo: "FX_Live_MX.html" },
      "PE": { nombre: "Per√∫", archivo: "FX_Live_PE.html" },
      "CO": { nombre: "Colombia", archivo: "FX_Live_CO.html" }
    };

    const picker = document.getElementById("picker");
    const loader = document.getElementById("loader");
    const errorMessage = document.getElementById("errorMessage");
    const retryBtn = document.getElementById("retryBtn");
    const frameA = document.getElementById("frameA");
    const frameB = document.getElementById("frameB");

    let visible = frameA;
    let currentCountry = null;
    let loadingTimeout = null;
    let isLoading = false;

    // Crear botones
    for (const cod of Object.keys(reportes)) {
      const btn = document.createElement("button");
      btn.className = "country-btn";
      btn.type = "button";
      btn.dataset.cod = cod;
      btn.textContent = reportes[cod].nombre;
      btn.addEventListener("click", () => setPais(cod));
      picker.appendChild(btn);
    }

    // Bot√≥n retry
    retryBtn.addEventListener("click", () => {
      if (currentCountry) {
        hideError();
        setPais(currentCountry);
      }
    });

    const params = new URLSearchParams(location.search);
    const paisInicial = (params.get("country") || "GT").toUpperCase();

    function markActive(cod) {
      for (const b of picker.querySelectorAll(".country-btn")) {
        const isActive = b.dataset.cod === cod;
        b.classList.toggle("active", isActive);
        b.setAttribute("aria-pressed", isActive ? "true" : "false");
        b.disabled = isLoading; // Deshabilitar durante carga
      }
    }

    function showLoader() {
      loader.classList.add("show");
      errorMessage.classList.remove("show");
    }

    function hideLoader() {
      loader.classList.remove("show");
      if (loadingTimeout) {
        clearTimeout(loadingTimeout);
        loadingTimeout = null;
      }
    }

    function showError() {
      loader.classList.remove("show");
      errorMessage.classList.add("show");
      isLoading = false;
      markActive(currentCountry); // Re-habilitar botones
    }

    function hideError() {
      errorMessage.classList.remove("show");
    }

    function setPais(cod) {
      const info = reportes[cod];
      if (!info || isLoading) return;

      // Evitar cargar el mismo pa√≠s
      if (cod === currentCountry && visible.classList.contains("show")) {
        return;
      }

      isLoading = true;
      currentCountry = cod;
      hideError();
      showLoader();

      // Timeout de seguridad (10 segundos)
      loadingTimeout = setTimeout(() => {
        showError();
      }, 10000);

      const hidden = (visible === frameA) ? frameB : frameA;

      // Limpiar eventos previos
      hidden.onload = null;
      hidden.onerror = null;

      // Preparar iframe oculto
      hidden.classList.remove("show");

      // Eventos de carga
      hidden.onload = () => {
        if (cod !== currentCountry) return; // Ignorar si ya cambi√≥

        hideLoader();
        hidden.classList.add("show");
        visible.classList.remove("show");
        visible = hidden;
        isLoading = false;
        markActive(cod);
      };

      hidden.onerror = () => {
        if (cod !== currentCountry) return;
        showError();
      };

      // Verificar si el archivo existe antes de cargar
      fetch(info.archivo, { method: 'HEAD' })
        .then(response => {
          if (!response.ok) throw new Error('Archivo no encontrado');
          hidden.src = info.archivo;
        })
        .catch(() => {
          showError();
        });

      // Actualizar URL
      const url = new URL(location);
      url.searchParams.set("country", cod);
      history.replaceState({}, "", url);
    }

    function boot(cod) {
      const info = reportes[cod] || reportes[Object.keys(reportes)[0]];
      currentCountry = cod;
      showLoader();
      
      // Timeout de seguridad
      loadingTimeout = setTimeout(() => {
        showError();
      }, 10000);

      visible.onload = () => {
        if (cod !== currentCountry) return;
        hideLoader();
        visible.classList.add("show");
        isLoading = false;
        markActive(cod);
      };

      visible.onerror = () => {
        if (cod !== currentCountry) return;
        showError();
      };

      // Verificar archivo antes de cargar
      fetch(info.archivo, { method: 'HEAD' })
        .then(response => {
          if (!response.ok) throw new Error('Archivo no encontrado');
          visible.src = info.archivo;
        })
        .catch(() => {
          showError();
        });

      const url = new URL(location);
      url.searchParams.set("country", cod);
      history.replaceState({}, "", url);
    }

    // Prevenir navegaci√≥n m√∫ltiple r√°pida
    let debounceTimer = null;
    picker.addEventListener("click", (e) => {
      if (e.target.matches(".country-btn")) {
        if (debounceTimer) return;
        debounceTimer = setTimeout(() => {
          debounceTimer = null;
        }, 500);
      }
    });

    boot(reportes[paisInicial] ? paisInicial : Object.keys(reportes)[0]);
  </script>
</body>
</html>